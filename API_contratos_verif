# Carregar pacotes necessários
library(httr)
library(jsonlite)
library(stringr)
library(tidyr)
library(dplyr)
library(tidyverse)
library(lubridate)
library(openxlsx)
library(Microsoft365R)

# Lista para guardar cada entrada da API
lista <- list()

# Ano utilizado para carregar a API
ano <- "2024"

# UF utilizadas para carregar na API (Unidades Federativas)
UF <- c("SESI-AC", "SESI-AL", "SESI-AM", "SESI-AP", 
        "SESI-BA", "SESI-CE", "SESI-DF", "SESI-ES", 
        "SESI-GO", "SESI-MA", "SESI-MG", "SESI-MS", 
        "SESI-MT", "SESI-PA", "SESI-PB", "SESI-PE", 
        "SESI-PI", "SESI-PR", "SESI-RJ", "SESI-RN", 
        "SESI-RO", "SESI-RR", "SESI-RS", "SESI-SC", 
        "SESI-SE", "SESI-SP", "SESI-TO", "SESI-CN", 
        "SESI-DN", 
        "SENAI-AC", "SENAI-AL", "SENAI-AM", "SENAI-AP", 
        "SENAI-BA", "SENAI-CE", "SENAI-DF", "SENAI-ES", 
        "SENAI-GO", "SENAI-MA", "SENAI-MG", "SENAI-MS", 
        "SENAI-MT", "SENAI-PA", "SENAI-PB", "SENAI-PE", 
        "SENAI-PI", "SENAI-PR", "SENAI-RJ", "SENAI-RN", 
        "SENAI-RO", "SENAI-RR", "SENAI-RS", "SENAI-SC", 
        "SENAI-SE", "SENAI-SP", "SENAI-TO", "SENAI-CETIQT", 
        "SENAI-DN")

# Loop para utilizar cada UF como variável e puxar os dados da API
for (i in UF) {
  
  # Definir a entidade de entrada com base no formato da UF
  if (str_starts(string = i, "SESI")) {
    entidade <- "SESI"
  } else {
    entidade <- "SENAI"
  }
  
  # Base da API
  base <- 'https://sistematransparenciaweb.com.br/api-contratos/publico/contrato-patrocinio?'
  
  # Montar a chamada da API com os parâmetros
  call <- str_remove_all(paste(base, "entidade", "=", entidade, "&", "departamento", "=", i, "&", "ano", "=", ano), " ")
  
  # Fazer a requisição GET
  get_budget <- GET(call, type = "basic")
  
  # Obter o conteúdo da resposta como texto
  get_budget_text <- content(get_budget, "text")
  
  # Converter o texto JSON em uma lista R
  get_budget_json <- fromJSON(get_budget_text, flatten = TRUE)
  
  # Transformar a lista em um dataframe e expandir colunas
  get_budget_df <- as.data.frame(get_budget_json) %>% unnest()
  
  # Criar identificadores para a UF
  j <- which(UF == i)
  j <- str_remove(str_remove(UF, "SESI-"), "SENAI-")[j]
  
  # Criar colunas de marcação de Entidade, UF e ano
  get_budget_df <- get_budget_df %>% mutate(Entidade = rep(entidade, nrow(get_budget_df)),
                                            UF = rep(j, nrow(get_budget_df)))
  
  # Adicionar o dataframe na lista para guardar o resultado
  lista <- append(lista, list(get_budget_df))
}
#verificando quais DRs não tem dados
ufs_sem_dados <- UF[sapply(lista, function(df) nrow(df) == 0)]
ufs_sem_dados


# Combinar a lista em um dataframe único
dados <- bind_rows(lista)
dados <- dados %>% select(-fonte)
dados2 <- dados[, c(c(33,34), c(1:32))]

rm(get_budget)
rm(get_budget_df)
rm(get_budget_json)
rm(lista)

# Definir o diretório de trabalho e salvar os dados em um arquivo Excel
setwd("C:/Users/e-andre.araujo/Downloads")

write.xlsx(dados2, "contratos2025.xlsx")

# tentativa mais robusta
install.packages("writexl")
library(writexl)
write_xlsx(dados2, "contratos2025.xlsx")
